<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - TMS</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .approval-list {
            list-style: none;
            padding: 0;
        }
        .approval-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .approval-item .details p {
            margin: 0;
            font-size: 14px;
            color: #555;
        }
        .approval-item .details p strong {
            color: #333;
        }
        .approval-item .btn {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <nav class="top-bar">
        <div class="logo-container">
            <img src="/images/logo.jpg" alt="Logo" class="header-logo">
            <div class="logo-text">Transport Management System</div>
        </div>
        <a href="/" class="btn">Logout</a>
    </nav>
    <div class="home-container">
        <div class="home-box">
            <div class="profile-card">
                <div class="profile-icon">&#128100;</div>
                <div id="staff-name" class="student-name"></div>
                <div id="staff-designation" class="roll-number"></div>
                <div id="staff-id" class="roll-number"></div>
            </div>
        </div>
        <div class="home-box">
            <h3>Pending Approvals</h3>
            <div id="pending-approvals-container">
                <!-- Pending approvals will be populated here -->
            </div>
        </div>
    </div>

    <!-- Complaint Management Section -->
    <div class="complaint-management-section">
        <div class="home-box">
            <h3>Complaint Management</h3>
            <div id="complaints-list-container">
                <!-- Complaints will be populated here -->
            </div>
        </div>
    </div>

    <!-- SPOC Finder Section -->
    <div class="spoc-finder-section">
        <div class="home-box">
            <h3>SPOC Finder</h3>
            <div class="spoc-finder-options">
                <button id="find-by-route-btn" class="btn">Find SPOC by Route</button>
                <div class="spoc-finder-divider">OR</div>
                <button id="show-all-spocs-btn" class="btn">Show All SPOCs</button>
            </div>
            <form id="find-spoc-by-route-form" class="spoc-finder-form" style="display: none;">
                <input type="text" id="route-no-input" placeholder="Enter Route No." required>
                <button type="submit" class="btn">Find</button>
            </form>
        </div>
        <div id="spoc-results-container" style="display: none;">
            <!-- SPOC results will be populated here -->
        </div>
    </div>

    <!-- SPOC Modal Removed -->

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const name = urlParams.get('name');
        const designation = urlParams.get('designation');

        // Populate staff details
        if (id && name) {
            document.getElementById('staff-name').textContent = decodeURIComponent(name);
            document.getElementById('staff-designation').textContent = decodeURIComponent(designation);
            document.getElementById('staff-id').textContent = `ID: ${decodeURIComponent(id)}`;
        }

        // Fetch and render pending approvals
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/approvals/pending')
                .then(response => response.json())
                .then(approvals => {
                    const container = document.getElementById('pending-approvals-container');
                    if (approvals.length === 0) {
                        container.innerHTML = '<p>No pending approvals.</p>';
                        return;
                    }

                    const list = document.createElement('ul');
                    list.className = 'approval-list';
                    approvals.forEach(approval => {
                        const listItem = document.createElement('li');
                        listItem.className = 'approval-item';
                        listItem.id = `approval-${approval.Approval_id}`;
                        listItem.innerHTML = `
                            <div class="details">
                                <p><strong>Student:</strong> ${approval.student_name} (${approval.Roll_no})</p>
                                <p><strong>Route:</strong> ${approval.Route_no} - ${approval.Route_name}</p>
                                <p><strong>Date:</strong> ${new Date(approval.Date).toLocaleDateString()}</p>
                            </div>
                            <button class="btn" onclick="approveRequest(${approval.Approval_id})">Approve</button>
                        `;
                        list.appendChild(listItem);
                    });
                    container.appendChild(list);
                })
                .catch(error => {
                    console.error('Error fetching pending approvals:', error);
                    document.getElementById('pending-approvals-container').innerHTML = '<p>Error loading approvals.</p>';
                });

            fetchComplaints(); // Fetch and display all complaints
        });

        function approveRequest(approvalId) {
            const staffId = id; // Get staffId from URL params
            fetch('/api/approvals/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ approvalId, staffId })
            })
            .then(async response => {
                if (response.ok) {
                    alert('Request approved successfully!');
                    // Remove the approved item from the list
                    const itemToRemove = document.getElementById(`approval-${approvalId}`);
                    if (itemToRemove) {
                        itemToRemove.remove();
                    }
                    // Check if the list is now empty
                    const container = document.getElementById('pending-approvals-container');
                    if (!container.querySelector('.approval-item')) {
                        container.innerHTML = '<p>No pending approvals.</p>';
                    }
                } else {
                    const errorText = await response.text();
                    alert(`Failed to approve: ${errorText}`);
                }
            })
            .catch(error => {
                console.error('Error approving request:', error);
                alert('An error occurred while approving the request.');
            });
        }

        // --- COMPLAINT MANAGEMENT ---
        async function fetchComplaints() {
            try {
                const response = await fetch('/api/complaints');
                if (response.ok) {
                    const complaints = await response.json();
                    const container = document.getElementById('complaints-list-container');
                    container.innerHTML = ''; // Clear previous complaints

                    if (complaints.length === 0) {
                        container.innerHTML = '<p>No complaints submitted yet.</p>';
                        return;
                    }

                    const list = document.createElement('ul');
                    list.className = 'complaint-list'; // Add a class for styling
                    complaints.forEach(complaint => {
                        const listItem = document.createElement('li');
                        listItem.className = 'complaint-item'; // Add a class for styling
                        listItem.id = `complaint-${complaint.Complaint_id}`;
                        listItem.innerHTML = `
                            <div class="details">
                                <p><strong>ID:</strong> ${complaint.Complaint_id}</p>
                                <p><strong>Student:</strong> ${complaint.student_name} (${complaint.Roll_no})</p>
                                <p><strong>Type:</strong> ${complaint.Type}</p>
                                <p><strong>Description:</strong> ${complaint.Description}</p>
                                <p><strong>Reference ID:</strong> ${complaint.Reference_id || 'N/A'}</p>
                                <p><strong>Date:</strong> ${new Date(complaint.Date).toLocaleDateString()}</p>
                                <p><strong>Status:</strong> <span id="status-${complaint.Complaint_id}">${complaint.Status}</span></p>
                            </div>
                            <div class="actions">
                                <select onchange="updateComplaintStatus(${complaint.Complaint_id}, this.value)">
                                    <option value="">Change Status</option>
                                    <option value="in-progress" ${complaint.Status === 'in-progress' ? 'selected' : ''}>In-Progress</option>
                                    <option value="resolved" ${complaint.Status === 'resolved' ? 'selected' : ''}>Resolved</option>
                                </select>
                            </div>
                        `;
                        list.appendChild(listItem);
                    });
                    container.appendChild(list);
                } else {
                    console.error('Failed to fetch complaints:', await response.text());
                    document.getElementById('complaints-list-container').innerHTML = '<p>Error loading complaints.</p>';
                }
            } catch (error) {
                console.error('Error fetching complaints:', error);
                document.getElementById('complaints-list-container').innerHTML = '<p>Error loading complaints.</p>';
            }
        }

        async function updateComplaintStatus(complaintId, newStatus) {
            if (!newStatus) return; // Do nothing if "Change Status" is selected

            try {
                const response = await fetch(`/api/complaints/${complaintId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });

                if (response.ok) {
                    alert('Complaint status updated successfully!');
                    if (newStatus === 'resolved') {
                        // Remove the item from the view
                        const itemToRemove = document.getElementById(`complaint-${complaintId}`);
                        if (itemToRemove) {
                            itemToRemove.remove();
                        }
                        // Check if the list is now empty
                        const container = document.getElementById('complaints-list-container');
                        if (!container.querySelector('.complaint-item')) {
                            container.innerHTML = '<p>No active complaints.</p>';
                        }
                    } else {
                        // Just update the status text on the UI
                        document.getElementById(`status-${complaintId}`).textContent = newStatus;
                    }
                } else {
                    alert(`Failed to update status: ${await response.text()}`);
                }
            } catch (error) {
                console.error('Error updating complaint status:', error);
                alert('An error occurred while updating the complaint status.');
            }
        }

        // --- SPOC Details Removed ---

        // --- New SPOC Finder ---
        const findByRouteBtn = document.getElementById('find-by-route-btn');
        const spocForm = document.getElementById('find-spoc-by-route-form');
        const showAllSpocsBtn = document.getElementById('show-all-spocs-btn');
        const spocResultsContainer = document.getElementById('spoc-results-container');

        findByRouteBtn.addEventListener('click', () => {
            // Show the form when the "Find by Route" button is clicked
            spocForm.style.display = 'flex';
            findByRouteBtn.style.display = 'none'; // Optionally hide the initial button
        });

        spocForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const routeNo = document.getElementById('route-no-input').value;
            if (!routeNo) {
                alert('Please enter a route number.');
                return;
            }
            fetchAndRenderSpocs(`/api/spocs/${routeNo}`);
        });

        showAllSpocsBtn.addEventListener('click', () => {
            // Ensure the route search form is hidden if user clicks "Show All"
            spocForm.style.display = 'none';
            findByRouteBtn.style.display = 'inline-block';
            fetchAndRenderSpocs('/api/spocs');
        });

        async function fetchAndRenderSpocs(apiUrl) {
            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const spocs = await response.json();
                    renderSpocResults(spocs);
                } else {
                    console.error('Failed to fetch SPOC details:', await response.text());
                    spocResultsContainer.innerHTML = `<p class="error-message">Error fetching SPOC details.</p>`;
                    spocResultsContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching SPOC details:', error);
                spocResultsContainer.innerHTML = `<p class="error-message">An error occurred while fetching SPOC details.</p>`;
                spocResultsContainer.style.display = 'block';
            }
        }

        function renderSpocResults(spocs) {
            spocResultsContainer.innerHTML = ''; // Clear previous results
            if (spocs.length === 0) {
                spocResultsContainer.innerHTML = '<p>No SPOCs found for the given criteria.</p>';
            } else {
                const list = document.createElement('ul');
                list.className = 'spoc-results-list';
                spocs.forEach(spoc => {
                    const listItem = document.createElement('li');
                    listItem.className = 'spoc-result-item';
                    listItem.innerHTML = `
                        <p><strong>Name:</strong> ${spoc.student_name} (${spoc.Roll_no})</p>
                        <p><strong>Route:</strong> ${spoc.Route_name} (${spoc.Route_no})</p>
                        <p><strong>Mobile:</strong> ${spoc.Mobile}</p>
                        <p><strong>Email:</strong> ${spoc.Email}</p>
                    `;
                    list.appendChild(listItem);
                });
                spocResultsContainer.appendChild(list);
            }
            spocResultsContainer.style.display = 'block';
            spocResultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>